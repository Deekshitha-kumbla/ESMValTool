# recipe_gbrt_austral_jet_multidim_diags.yml
---
documentation:

  description: |
    Use GBRT (Gradient Boosted Regression Trees) models to predict future
    climate for multidimensional diagnostics.

  authors:
    - schl_ma

  references:
    null

  projects:
    - crescendo


datasets:
  - {dataset: CanESM2}
  - {dataset: IPSL-CM5A-LR}
  - {dataset: MIROC5}
  - {dataset: MIROC-ESM}
  - {dataset: MPI-ESM-LR}
  - {dataset: NorESM1-M}


preprocessors:

  time_average:
    time_average: null


diagnostics:

  diag_external_tas:
    variables:
      tas:
        project: CMIP5
        mip: Amon
        field: T2Ms
        exp: historical
        ensemble: r1i1p1
        start_year: 2000
        end_year: 2000
        preprocessor: time_average
        tag: DUMMY_TAS
        var_type: feature
        broadcast_from: [1, 2]
        additional_datasets:
          - {dataset: ERA-Interim, project: OBS, type: reanaly, version: 1, tier: 3, var_type: prediction_input}
    scripts:
      null

  diag_gbrt:
    description: Perform GBRT on input data.
    variables:
      ta: &variable_settings
        project: CMIP5
        mip: Amon
        field: T3M
        exp: historical
        ensemble: r1i1p1
        start_year: 1979
        end_year: 2005
        preprocessor: time_average
        tag: T
        var_type: feature
        additional_datasets:
          - {dataset: ERA-Interim, project: OBS, type: reanaly, version: 1, tier: 3, var_type: prediction_input}
      tas:
        <<: *variable_settings
        tag: TAS
        field: T2Ms
        broadcast_from: [1, 2]
        additional_datasets:
          - {dataset: ERA-Interim, project: OBS, type: reanaly, version: 1, tier: 3, var_type: prediction_input}
      ua:
        <<: *variable_settings
        tag: UA
        additional_datasets:
          - {dataset: ERA-Interim, project: OBS, type: reanaly, version: 1, tier: 3, var_type: prediction_input}
          - {dataset: CanESM2,      exp: rcp45, start_year: 2015, end_year: 2034, var_type: label}
          - {dataset: IPSL-CM5A-LR, exp: rcp45, start_year: 2015, end_year: 2034, var_type: label}
          - {dataset: MIROC5,       exp: rcp45, start_year: 2015, end_year: 2034, var_type: label}
          - {dataset: MIROC-ESM,    exp: rcp45, start_year: 2015, end_year: 2034, var_type: label}
          - {dataset: MPI-ESM-LR,   exp: rcp45, start_year: 2015, end_year: 2034, var_type: label}
          - {dataset: NorESM1-M,    exp: rcp45, start_year: 2015, end_year: 2034, var_type: label}
    scripts:
      multiple_gbrt_models:
        script: gbrt/multiple_gbrt_models.py
        ancestors: ['ta', 'tas', 'ua', 'diag_external_tas/*']
        use_coords_as_feature:
          air_pressure: 0
          latitude: 1
          longitude: 2
        metadata_preselection:
          select:
            project: CMIP5
          group: dataset
      single_gbrt_model:
        script: gbrt/single_gbrt_model.py
        ancestors: ['ta', 'tas', 'ua', 'diag_external_tas/*']
        use_coords_as_feature:
          air_pressure: 0
          latitude: 1
          longitude: 2
        group_datasets_by_attributes: ['dataset']

  diag_austral_jet_position:
    description: Calculate Austral Jet position.
    scripts:
      austral_jet_position:
        script: austral_jet/jet_position.py
        ancestors: [
          'diag_gbrt/multiple_gbrt_models',
          'diag_gbrt/single_gbrt_model',
        ]
