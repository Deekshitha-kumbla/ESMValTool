# recipe_mlr_co2.yml
---
documentation:

  description: |
    Use MLR (Machine Learning Regression) models to predict future CO2 fluxes.

  authors:
    - schl_ma

  maintainer:
    - schl_ma

  projects:
    - crescendo


DATASET_ANCHOR: &datasets
  - {dataset: BNU-ESM}
  - {dataset: CanESM2}
  - {dataset: CCSM4}
  - {dataset: CESM1-BGC}
  - {dataset: GFDL-ESM2G}
  - {dataset: GFDL-ESM2M}
  - {dataset: HadGEM2-CC}
  - {dataset: HadGEM2-ES}
  - {dataset: inmcm4}
  - {dataset: IPSL-CM5A-LR}
  - {dataset: IPSL-CM5A-MR}
  - {dataset: IPSL-CM5B-LR}
  - {dataset: MIROC-ESM}
  - {dataset: MIROC-ESM-CHEM}
  - {dataset: MPI-ESM-LR}
  - {dataset: MPI-ESM-MR}
  - {dataset: NorESM1-M}
  - {dataset: NorESM1-ME}


preprocessors:

  mask_sea: &mask_sea
    mask_landsea:
      mask_out: sea
    extract_region:
      start_latitude: -60.0
      end_latitude: 90.0
      start_longitude: 0.0
      end_longitude: 360.0

  time_average:
    <<: *mask_sea
    time_average: null

  regrid:
    <<: *mask_sea
    regrid:
      scheme: nearest
      target_grid: 1x1


diagnostics:

  diag_mlr_input_tas:
    variables:
      features: &variable_settings
        short_name: tas
        preprocessor: mask_sea
        project: CMIP5
        mip: Amon
        field: T2Ms
        exp: historical
        ensemble: r1i1p1
        start_year: 1986
        end_year: 2005
        var_type: feature
        additional_datasets: *datasets
      prediction_input:
        <<: *variable_settings
        preprocessor: regrid
        var_type: prediction_input
        additional_datasets:
          - {dataset: CRU, project: OBS, type: reanaly, version: 1, tier: 3}
    scripts:
      mean: &mean
        script: mlr/single_var.py
        mean: ['time']
        tag: T-Glob_c
        convert_units_to: celsius
      trend: &trend
        script: mlr/single_var.py
        trend: year
        tag: T-Glob_t

  diag_mlr_input_pr:
    variables:
      features:
        <<: *variable_settings
        short_name: pr
      prediction_input:
        <<: *variable_settings
        short_name: pr
        preprocessor: regrid
        var_type: prediction_input
        additional_datasets:
          - {dataset: CRU, project: OBS, type: reanaly, version: 1, tier: 3}
    scripts:
      mean:
        <<: *mean
        tag: PR-Glob_c
        convert_units_to: 'kg m-2 day-1'
      trend:
        <<: *trend
        tag: PR-Glob_t
        convert_units_to: 'kg m-2 day-1 year-1'

  diag_mlr_input_nbp:
    variables:
      features:
        <<: *variable_settings
        short_name: nbp_grid
        mip: Lmon
        derive: true
      prediction_input:
        <<: *variable_settings
        short_name: nbp_grid
        preprocessor: regrid
        mip: Lmon
        derive: true
        var_type: prediction_input
        additional_datasets:
          - {dataset: JMA-TRANSCOM, project: OBS, type: reanaly, version: 1, tier: 3}
    scripts:
      mean:
        <<: *mean
        tag: NBP-Glob_c
        convert_units_to: 'Gt yr-1'
      trend:
        <<: *trend
        tag: NBP-Glob_t
        convert_units_to: 'Gt yr-2'

  diag_mlr:
    description: Perform MLR on input data.
    variables:
      label:
        <<: *variable_settings
        short_name: nbp_grid
        preprocessor: time_average
        mip: Lmon
        exp: rcp45
        start_year: 2020
        end_year: 2040
        derive: true
        var_type: label
        tag: NBP
        convert_units_to: 'Gt yr-1'
    scripts:
      multiple_mlr_models:
        script: mlr/main_gpr.py
        ancestors: [
          'label',
          'diag_mlr_input_*/mean',
          'diag_mlr_input_*/trend',
        ]
        use_coords_as_feature: ['latitude', 'longitude']
        metadata_preselection:
          select:
            project: CMIP5
          group: dataset
