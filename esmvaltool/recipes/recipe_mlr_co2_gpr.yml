# recipe_mlr_co2_gpr.yml
---
documentation:

  description: |
    Use MLR (Machine Learning Regression) models to constrain projections of
    CO2 fluxes with gridded data.

  authors:
    - schlund_manuel

  maintainer:
    - schlund_manuel

  projects:
    - crescendo


DATASET_ANCHOR: &datasets
  - {dataset: BNU-ESM}
  - {dataset: CanESM2}
  # - {dataset: CCSM4}
  # - {dataset: CESM1-BGC}
  # - {dataset: GFDL-ESM2G}
  # - {dataset: GFDL-ESM2M}
  # - {dataset: HadGEM2-CC}
  # - {dataset: HadGEM2-ES}
  - {dataset: inmcm4}
  # - {dataset: IPSL-CM5A-LR}
  # - {dataset: IPSL-CM5A-MR}
  # - {dataset: IPSL-CM5B-LR}
  # - {dataset: MIROC-ESM}
  # - {dataset: MIROC-ESM-CHEM}
  # - {dataset: MPI-ESM-LR}
  # - {dataset: MPI-ESM-MR}
  # - {dataset: NorESM1-M}
  # - {dataset: NorESM1-ME}


preprocessors:

  regular_var: &regular_var
    mask_landsea:
      mask_out: sea
    extract_region:
      start_latitude: -60.0
      end_latitude: 90.0
      start_longitude: 0.0
      end_longitude: 360.0
    regrid:
      scheme: nearest
      target_grid: 10x10

  flux_var:
    <<: *regular_var
    weighting_landsea_fraction:
      area_type: land
      strict: false


diagnostics:

  diag_mlr_input_tas:
    variables:
      features: &variable_settings_features
        short_name: tas
        preprocessor: regular_var
        project: CMIP5
        mip: Amon
        exp: historical
        ensemble: r1i1p1
        start_year: 1991
        end_year: 2005
        var_type: feature
        additional_datasets: *datasets
      prediction_input: &variable_settings_prediction_input
        <<: *variable_settings_features
        var_type: prediction_input
        additional_datasets:
          - {dataset: CRU, project: OBS, type: reanaly, version: TS4.02, tier: 2}
    scripts:
      monthly_clim: &monthly_clim
        script: mlr/preprocess.py
        aggregate_by:
          month_number: mean
        tag: T_c
        convert_units_to: celsius

  diag_mlr_input_pr:
    variables:
      features:
        <<: *variable_settings_features
        short_name: pr
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: pr
        additional_datasets:
          - {dataset: CRU, project: OBS, type: reanaly, version: TS4.02, tier: 2}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: PR_c
        convert_units_to: 'kg m-2 day-1'

  diag_mlr_input_rsds:
    variables:
      features:
        <<: *variable_settings_features
        short_name: rsds
        start_year: 2001
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: rsds
        start_year: 2001
        additional_datasets:
          - {dataset: CERES-EBAF, project: obs4mips, level: L3B, version: Ed2-7, tier: 1}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: SSRD_c
        convert_units_to: null

  diag_mlr_input_rsus:
    variables:
      features:
        <<: *variable_settings_features
        short_name: rsus
        start_year: 2001
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: rsus
        start_year: 2001
        additional_datasets:
          - {dataset: CERES-EBAF, project: obs4mips, level: L3B, version: Ed2-7, tier: 1}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: SSRU_c
        convert_units_to: null

  diag_mlr_input_rlds:
    variables:
      features:
        <<: *variable_settings_features
        short_name: rlds
        start_year: 2001
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: rlds
        start_year: 2001
        additional_datasets:
          - {dataset: CERES-EBAF, project: obs4mips, level: L3B, version: Ed2-7, tier: 1}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: SLRD_c
        convert_units_to: null

  diag_mlr_input_rlus:
    variables:
      features:
        <<: *variable_settings_features
        short_name: rlus
        start_year: 2001
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: rlus
        start_year: 2001
        additional_datasets:
          - {dataset: CERES-EBAF, project: obs4mips, level: L3B, version: Ed2-7, tier: 1}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: SLRU_c
        convert_units_to: null

  diag_mlr_input_et:
    variables:
      features:
        <<: *variable_settings_features
        short_name: et
        mip: Lmon
        derive: true
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: et
        mip: Lmon
        derive: true
        additional_datasets:
          - {dataset: LandFlux-EVAL, project: OBS, type: reanaly, version: Oct13, tier: 3}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: ET_c
        convert_units_to: null

  diag_mlr_input_nbp:
    variables:
      features:
        <<: *variable_settings_features
        short_name: nbp
        preprocessor: flux_var
        mip: Lmon
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: nbp
        preprocessor: flux_var
        mip: Lmon
        additional_datasets:
          - {dataset: JMA-TRANSCOM, project: OBS, type: reanaly, version: 2018, tier: 3}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: NBP_c
        convert_units_to: 'Gt km-2 yr-1'

  diag_mlr_input_gpp:
    variables:
      features:
        <<: *variable_settings_features
        short_name: gpp
        preprocessor: flux_var
        mip: Lmon
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: gpp
        preprocessor: flux_var
        mip: Lmon
        additional_datasets:
          - {dataset: MTE, project: OBS, type: reanaly, version: May12, tier: 3}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: GPP
        convert_units_to: 'Gt km-2 yr-1'

  diag_mlr_input_lai:
    variables:
      features:
        <<: *variable_settings_features
        short_name: lai
        preprocessor: flux_var
        mip: Lmon
      prediction_input:
        <<: *variable_settings_prediction_input
        short_name: lai
        preprocessor: flux_var
        mip: Lmon
        additional_datasets:
          - {dataset: LAI3g, project: OBS, type: reanaly, version: 1_regridded, tier: 3, var_type: prediction_input}
    scripts:
      monthly_clim:
        <<: *monthly_clim
        tag: LAI_c
        convert_units_to: null

  diag_mlr:
    description: Perform MLR on input data.
    variables:
      ref:
        <<: *variable_settings_features
        short_name: gpp
        preprocessor: flux_var
        mip: Lmon
        ref: true
      label: &variable_settings_label
        <<: *variable_settings_features
        short_name: gpp
        preprocessor: flux_var
        mip: Lmon
        exp: rcp45
        start_year: 2021
        end_year: 2035
        var_type: label
    scripts:
      monthly_clim:
        <<: *monthly_clim
        anomaly:
          matched_by: ['dataset']
        tag: GPP
        convert_units_to: 'Gt km-2 yr-1'
      multiple_mlr_models:
        script: mlr/main.py
        ancestors: [
          'diag_mlr/monthly_clim',
          'diag_mlr_input_*/monthly_clim',
        ]
        coords_as_features: ['month_number', 'latitude', 'longitude']
        grid_search_cv_kwargs:
          cv: 2
        grid_search_cv_param_grid:
          final__regressor__n_restarts_optimizer: [2, 3]
        group_metadata: dataset
        mlr_model_type: gpr_george
        parameters_final_regressor:
          white_noise: 0.05
        predict_kwargs:
          return_cov: true
      postprocess:
        script: mlr/postprocess.py
        ancestors: [
          'diag_mlr/multiple_mlr_models',
          'diag_mlr_input_gpp/monthly_clim',
        ]
        mean: ['time']
        sum: ['latitude', 'longitude']
        convert_units_to: Gt yr-1
